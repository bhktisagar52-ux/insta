// Instagram-like Social Media Platform Schema with Reels Support
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id            String    @id @default(cuid())
  username      String    @unique
  email         String    @unique
  password      String
  name          String?
  bio           String?
  avatar        String?
  website       String?
  isPrivate     Boolean   @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  posts         Post[]
  reels         Reel[]
  comments      Comment[]
  likes         Like[]
  videoLikes    VideoLike[]
  bookmarks     Bookmark[]
  followers     Follow[]   @relation("UserFollowers")
  following     Follow[]   @relation("UserFollowing")
  notifications Notification[] @relation("NotificationUser")
  sentMessages  Message[]  @relation("MessageSender")
  receivedMessages Message[]  @relation("MessageReceiver")
  stories       Story[]
  storyViews    StoryView[]
  reelViews     ReelView[]
  videoComments VideoComment[]
  videoShares   VideoShare[]
  videoSharesReceived VideoShare[] @relation("VideoSharesReceiver")

  @@index([username])
  @@index([email])
}

// Reel/Video model (Instagram Reels)
model Reel {
  id          String   @id @default(cuid())
  userId      String
  videoUrl    String   // Video file URL from Cloudinary
  thumbnailUrl String?  // Thumbnail image URL
  caption     String?
  location    String?
  duration    Int      // Video duration in seconds
  width       Int      // Video width
  height      Int      // Video height
  aspectRatio String?   // e.g., "9:16", "1:1", "16:9"
  audioUrl    String?   // Background music URL
  musicName   String?   // Song title for attribution
  mentionIds  String?   // Comma-separated mentioned user IDs
  isPrivate   Boolean  @default(false)
  allowComments Boolean @default(true)
  allowDuet    Boolean @default(false)
  allowRemix   Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime @default(now())
  expiresAt   DateTime? // Optional: Reels expire after 90 days

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes       VideoLike[]
  comments    VideoComment[]
  shares      VideoShare[]
  views       ReelView[]

  @@index([userId])
  @@index([createdAt])
  @@index([publishedAt])
  @@index([expiresAt])
}

// VideoLike model (for Reels)
model VideoLike {
  id        String   @id @default(cuid())
  userId    String
  reelId    String
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reel      Reel     @relation(fields: [reelId], references: [id], onDelete: Cascade)

  @@unique([userId, reelId])
  @@index([reelId])
  @@index([userId])
}

// VideoComment model (for Reels)
model VideoComment {
  id        String   @id @default(cuid())
  content   String
  userId    String
  reelId    String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reel      Reel     @relation(fields: [reelId], references: [id], onDelete: Cascade)
  parent    VideoComment? @relation("VideoCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   VideoComment[] @relation("VideoCommentReplies")

  @@index([reelId])
  @@index([userId])
  @@index([createdAt])
  @@index([parentId])
}

// VideoShare model (for Reels)
model VideoShare {
  id        String   @id @default(cuid())
  userId    String
  reelId    String
  platform  String   // "instagram", "facebook", "twitter", "whatsapp", "copy_link", etc.
  shareUrl  String?  // URL to shared content (if external)
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reel      Reel     @relation(fields: [reelId], references: [id], onDelete: Cascade)

  @@index([reelId])
  @@index([userId])
  @@index([platform])
  @@index([createdAt])
}

// ReelView model (track video views)
model ReelView {
  id        String   @id @default(cuid())
  reelId    String
  userId    String   // Who viewed the reel
  viewedAt  DateTime @default(now())
  watchTime  Float?  // How long they watched (for analytics)
  completed Boolean @default(false) // Did they finish watching?

  // Relations
  viewer    User   @relation("ReelViewer", fields: [userId], references: [id], onDelete: Cascade)
  reel      Reel   @relation(fields: [reelId], references: [id], onDelete: Cascade)

  @@index([reelId])
  @@index([userId])
  @@index([viewedAt])
}

// VideoHashtag junction (for Reels)
model VideoHashtag {
  id        String   @id @default(cuid())
  name      String   @unique
  count     Int      @default(0) // How many reels use this hashtag
  createdAt DateTime @default(now())

  // Relations
  reels     VideoHashtagReel[]

  @@index([name])
}

// VideoHashtagReel junction
model VideoHashtagReel {
  id        String   @id @default(cuid())
  reelId    String
  hashtagId String
  createdAt DateTime @default(now())

  // Relations
  reel      Reel     @relation(fields: [reelId], references: [id], onDelete: Cascade)
  hashtag VideoHashtag @relation(fields: [hashtagId], references: [id], onDelete: Cascade)

  @@unique([reelId, hashtagId])
  @@index([hashtagId])
}

// Post model (Photo posts)
model Post {
  id          String   @id @default(cuid())
  caption     String?
  imageUrl    String
  location    String?
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments    Comment[]
  likes       Like[]
  bookmarks   Bookmark[]
  hashtags    PostHashtag[]

  @@index([userId])
  @@index([createdAt])
}

// Comment model (for photo posts)
model Comment {
  id        String   @id @default(cuid())
  content   String
  userId    String
  postId    String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}

// Like model (for photo posts)
model Like {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
}

// Follow model
model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  // Relations
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// Notification model
model Notification {
  id        String   @id @default(cuid())
  type      String   // like, comment, follow, mention, reply, story_like, reel_like, reel_comment, reel_share
  userId    String
  actorId   String?  // User who triggered the notification
  postId    String?
  commentId String?
  reelId    String?   // For reel-related notifications
  videoCommentId String?  // For video comment notifications
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user       User     @relation("NotificationUser", fields: [userId], references: [id], onDelete: Cascade)
  actor     User?     @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)
  post       Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  reel       Reel?    @relation(fields: [reelId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// Bookmark/Save model
model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

// Message model (Direct Messaging)
model Message {
  id        String   @id @default(cuid())
  content   String
  imageUrl  String?
  senderId  String
  receiverId String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  sender    User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver  User     @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

// Story model (Photo stories)
model Story {
  id          String   @id @default(cuid())
  imageUrl    String
  userId      String
  caption     String?
  expiresAt   DateTime // Stories expire after 24 hours
  createdAt   DateTime @default(now())

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  views       StoryView[]

  @@index([userId])
  @@index([expiresAt])
}

// StoryView model (who viewed which story)
model StoryView {
  id        String   @id @default(cuid())
  storyId   String
  userId    String
  viewedAt  DateTime @default(now())

  // Relations
  story     Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storyId, userId])
  @@index([storyId])
}

// Hashtag model (for photo posts)
model Hashtag {
  id        String   @id @default(cuid())
  name      String   @unique
  count     Int      @default(0) // Number of posts with this hashtag
  createdAt DateTime @default(now())

  // Relations
  posts     PostHashtag[]

  @@index([name])
}

// Post-Hashtag junction table (for photo posts)
model PostHashtag {
  id        String   @id @default(cuid())
  postId    String
  hashtagId String
  createdAt DateTime @default(now())

  // Relations
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  hashtag   Hashtag  @relation(fields: [hashtagId], references: [id], onDelete: Cascade)

  @@unique([postId, hashtagId])
  @@index([hashtagId])
  @@index([postId])
}

// VideoAnalytics model (track reel performance)
model VideoAnalytics {
  id           String   @id @default(cuid())
  reelId       String
  userId       String
  views        Int      @default(0)
  likes        Int      @default(0)
  comments     Int      @default(0)
  shares       Int      @default(0)
  watchTime    Float    @default(0)  // Total watch time in seconds
  completionRate Float @default(0) // % of viewers who finished watching
  engagementRate Float @default(0)  // (likes + comments + shares) / views
  recordedAt  DateTime @default(now())

  // Relations
  reel  Reel     @relation(fields: [reelId], references: [id], onDelete: Cascade)
  user  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reelId, recordedAt])
  @@index([reelId])
  @@index([recordedAt])
}

// TrendingReel model (cache for trending reels)
model TrendingReel {
  id              String   @id @default(cuid())
  reelId          String
  score           Float    // Engagement score
  views           Int      @default(0)
  trendPeriod     String   // "daily", "weekly", "monthly"
  position        Int      // Position in trending list
  calculatedAt    DateTime @default(now())
  expiresAt       DateTime @default(now()) // Recalculate every 6 hours

  // Relations
  reel            Reel     @relation(fields: [reelId], references: [id], onDelete: Cascade)

  @@unique([reelId, trendPeriod])
  @@index([score])
  @@index([trendPeriod])
  @@index([expiresAt])
}
